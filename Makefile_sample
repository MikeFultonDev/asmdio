SRCDIR=sample
DEPDIR=sample/deps
BLDDIR=obj
BINDIR=bin
archive=asmdio.a

csource := $(shell find $(SRCDIR) -type f -name *.c)
cobjs   := $(patsubst $(SRCDIR)/%,$(BLDDIR)/%,$(csource:.c=.o))
objects := $(cobjs)
cdeps   := $(patsubst $(SRCDIR)/%,$(DEPDIR)/%,$(csource:.c=.d))
pgms    := $(BINDIR)/f2m $(BINDIR)/m2f $(BINDIR)/mlsx $(BINDIR)/mchtag $(BINDIR)/readupdate $(BINDIR)/readwriterec
all: $(pgms)

clean:
	rm -rf $(objects) $(pgms) $(DEPDIR)

$(DEPDIR)/%.d: $(SRCDIR)/%.c
	mkdir -p $(DEPDIR) ; \
	rm -f $@; \
	clang -MM -MP $(CPPFLAGS) $< > $@;

include $(cdeps)

$(BINDIR)/readwriterec: $(BLDDIR)/readwriterec.o $(BLDDIR)/msg.o $(BLDDIR)/bpamio.o $(BLDDIR)/ztime.o $(BLDDIR)/memdir.o $(BLDDIR)/ispf.o $(BLDDIR)/$(archive)
	$(LD) $(LDFLAGS) -o $@ $^ >$@.llst

$(BINDIR)/readupdate: $(BLDDIR)/readupdate.o $(BLDDIR)/msg.o $(BLDDIR)/bpamio.o $(BLDDIR)/ztime.o $(BLDDIR)/memdir.o $(BLDDIR)/ispf.o $(BLDDIR)/$(archive)
	$(LD) $(LDFLAGS) -o $@ $^ >$@.llst

$(BINDIR)/f2m: $(BLDDIR)/f2m.o $(BLDDIR)/fsio.o $(BLDDIR)/msg.o $(BLDDIR)/fmopts.o $(BLDDIR)/filemap.o $(BLDDIR)/bpamio.o $(BLDDIR)/ztime.o $(BLDDIR)/ispf.o $(BLDDIR)/$(archive)
	$(LD) $(LDFLAGS) -o $@ $^ >$@.llst

$(BINDIR)/mlsx: $(BLDDIR)/mlsx.o $(BLDDIR)/mlsxopts.o $(BLDDIR)/bpamio.o $(BLDDIR)/msg.o $(BLDDIR)/memdir.o $(BLDDIR)/ztime.o $(BLDDIR)/ispf.o $(BLDDIR)/$(archive)
	$(LD) $(LDFLAGS) -o $@ $^ >$@.llst

$(BINDIR)/mchtag: $(BLDDIR)/mchtag.o
	$(LD) $(LDFLAGS) -o $@ $< >$@.lst

$(BINDIR)/m2f: $(BLDDIR)/m2f.o $(BLDDIR)/fsio.o $(BLDDIR)/msg.o $(BLDDIR)/fmopts.o $(BLDDIR)/filemap.o $(BLDDIR)/bpamio.o $(BLDDIR)/ztime.o $(BLDDIR)/memdir.o $(BLDDIR)/ispf.o $(BLDDIR)/$(archive)
	$(LD) $(LDFLAGS) -o $@ $^ >$@.llst

$(BLDDIR)/%.o: $(SRCDIR)/%.c
	mkdir -p $(BLDDIR) ;
	$(CC) $(CPPFLAGS) $(CFLAGS) -c -o $@ $<

.PHONY: all clean